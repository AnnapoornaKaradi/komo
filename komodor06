locals {
    komodor_secret_name = "komodor-api-key"
}

data "azurerm_key_vault_secret" "komodor_api_key" {
    name = local.komodor_secret_name
    key_vault_id = try (
      data.terraform_remote_state.baseinfra_00["local"].outputs.key_vaults["env"]["infra"].id
    )
}

locals {
    komodor_cluster_name = try(
        data.terraform_remote_state.baseinfra_00["local"].outputs["aks"][var.env_ref]["name"]
    )
}

resource "kubernetes_secret" "komodor" {
    metadata {
      name = "komodor-secrets-${var.env_ref}"
      namespace = "komodor"
    }

    data = {
      apiKey = base64encode(data.azurerm_key_vault_secret.komodor_api_key.value)
    }
    type = "Opaque"

}

resource "helm_release" "komodor_agent" {
  name       = "komodor-agent"
  repository = "https://helm.komodor.io"
  chart      = "komodorio/komodor-agent"
  namespace  = "komodor"
  create_namespace = false

  set {
    name  = "clusterName"
    value = local.komodor_cluster_name
  }

  # Values file ensures API key comes from secret
  values = [
    <<-YAML
    env:
    - name: KOMODOR_API_KEY
      valueFrom:
        secretKeyRef:
          name: komodor-secrets-${var.env_ref}
          key: apiKey
    YAML
  ]

  depends_on = [kubernetes_secret.komodor]
}
